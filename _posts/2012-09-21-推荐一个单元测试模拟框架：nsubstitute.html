---
layout: post
title: 推荐一个单元测试模拟框架：Nsubstitute
---

<p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">推荐单元测试新的模拟框架：Nsubstitute</p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"> </p><p style="margin-top: 0pt; margin-bottom: 0pt" class="p0">目前，.NET已经有很多强大模拟框架，为什么还要再重新写一个呢？按照Nsubstitute的官方说法是：所有的模拟框架都已经有强大的功能，但是现存的框架当中，没有一个满足我们对更简洁语法风格的追求。</p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><!--EndFragment--><o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="text-align: left; padding-bottom: 0pt; line-height: 150%; margin-top: 0pt; padding-left: 0pt; padding-right: 0pt; margin-bottom: 0pt; padding-top: 0pt" class="p0">第一次看到Nsubstitute，是在看Nunit的源码时发现，实际上Nunit已经不推荐大家使用它原来的Mock框架，它引入了Nsubstitute。经了解，Nsubstitute已经是一个具有两年多历史的模拟框架，也算是比较年轻的框架，它昨天（2012-5-4）刚发布了1.4版本。模拟框架很多，我们的选择很多，但是从现在开始，我们可以考虑一下用Nsubstitute，多了一个选择。<o:p></o:p></p><p style="text-align: left; padding-bottom: 0pt; line-height: 150%; margin-top: 0pt; padding-left: 0pt; padding-right: 0pt; margin-bottom: 0pt; padding-top: 0pt" class="p0"><o:p></o:p></p><p style="text-align: left; padding-bottom: 0pt; line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; padding-left: 0pt; padding-right: 0pt; margin-bottom: 0pt; margin-left: 21.25pt; padding-top: 0pt" class="p0">1.Nsubstitute简介<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">它是一个开源的框架，源码是C#实现的。你可以在这里获得它的源码：https://github.com/nsubstitute/NSubstitute<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">NSubstitute更注重替代（Substitute）概念。它的设计目标是提供一个优秀的测试替代的.NET模拟框架。它是一个模拟测试框架，用最简洁的语法，使得我们能够把更多的注意力放在测试工作，减轻我们的测试配置工作，以满足我们的测试需求，帮助完成测试工作。它提供最经常需要使用的测试功能，且易于使用，语句更符合自然语言，可读性更高。对于单元测试的新手或只专注于测试的开发人员，它具有简单、友好的语法，使用更少的lambda表达式来编写完美的测试程序。</p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></p><p style="margin-top: 0pt; margin-bottom: 0pt" class="p0"> NSubstitute采用的是Arrange-Act-Assert测试模式，你只需要告诉它应该如何工作，然后断言你所期望接收到的请求，就大功告成了。因为你有更重要的代码要编写，而不是去考虑是需要一个Mock还是一个Stub。</p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><!--EndFragment--></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">对比Moq，NSubstitute的语法比更简练。这里的主要目的并不是为了比较框架的优劣。<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="text-align: left; padding-bottom: 0pt; line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; padding-left: 0pt; padding-right: 0pt; margin-bottom: 0pt; margin-left: 21.25pt; padding-top: 0pt" class="p0">2.如何获取Nsubstitute？<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">有两种获得Nsubstitute的方式：<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">一是通过NuGet或者OpenWrap工具在Vs2010上安装Nsubstitute。<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">二是通过下载Nsubstitute组件（https://github.com/nsubstitute/nsubstitute/downloads)，然后在测试项目当中引用NSubstitute.dll文件。现在的最新版本是1.4。<o:p></o:p></p><p style="text-align: left; padding-bottom: 0pt; line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; padding-left: 0pt; padding-right: 0pt; margin-bottom: 0pt; margin-left: 21.25pt; padding-top: 0pt" class="p0">3.测试方法<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">可以创建接口的实例，并设定接口方法的返回值，供测试。<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">1)定义一个最基本的计算器接口：<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">publicinterfaceICalculator<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">{<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">intAdd(inta,intb);<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">intSubtract(inta,intb);<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">}<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">2)创建测试项目、及测试程序<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">3)引用命名空间声明<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">首先，在C#测试源码文件添加命名空间引用<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">usingNSubstitute。<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">4)创建接口实例<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">calculator=Substitute.For&lt;ICalculator&gt;();<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">5)设定替代对象的接口方法返回值<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">指定Add被调用时，传入参数值分别为1、2时，替代的返回值为3<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">calculator.Add(1,2).Returns(3);<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">6)断言<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">Assert.AreEqual(calculator.Add(1,2),3);<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">7)Received的使用<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">另外，我们还可以检验替代对象的指定场景是否被调用，而哪些场景没有被调用，例如：<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">calculator.Add(1,2);<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">calculator.Received().Add(1,2);<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">calculator.DidNotReceive().Add(5,7);<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">如果场景在之前没有被调用，Received()断言则会失败。<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">例如：calculator.Received().Add(2,3);<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">我们将会发现测试异常的提示信息如下：<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">测试方法Calculator.Tests.ICalculatorTest.AddTest引发了异常:<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">NSubstitute.Exceptions.ReceivedCallsException:Expectedtoreceiveacallmatching:<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">Add(2,3)<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">Actuallyreceivednomatchingcalls.<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">Received1non-matchingcall(non-matchingargumentsindicatedwith'*'characters):<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">Add(*1*,*2*)<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">NSubstitute支持设置参数返回值，并断言已经被调用。下面是更复杂的使用：<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">calculator.Add(10,-5);<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">calculator.Received().Add(10,Arg.Any&lt;int&gt;());//第二个参数的值为任一int类型的整数。<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">calculator.Received().Add(10,Arg.Is&lt;int&gt;(x=&gt;x&lt;0));//第二个参数的值必须是小于零，否则将报异常<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">我们还可以使用替代对象的参数匹配及通过Returns()方法得到一些更多的行为:<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">//定义第一个参数及第二个参数为任意整数，并且返回值为两个参数之和。<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">calculator.Add(Arg.Any&lt;int&gt;(),Arg.Any&lt;int&gt;()).Returns(x=&gt;(int)x[0]+(int)x[1]);<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">Assert.AreEqual(calculator.Add(5,10),15);<o:p></o:p></p><p style="text-align: left; padding-bottom: 0pt; line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; padding-left: 0pt; padding-right: 0pt; margin-bottom: 0pt; margin-left: 21.25pt; padding-top: 0pt" class="p0">4.测试对象属性及事件委托<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">1)定义一个接口：<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">publicinterfaceIPerson<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">{<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">stringName{get;set;}<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">eventEventHandlerSleep;<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">}<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">2)创建测试项目、及测试程序<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">3)引用NSubstitute.dll，并声明命名空间<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">首先，在C#测试源码文件添加命名空间引用<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">usingNSubstitute。<o:p></o:p></p><p style="text-align: justify; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">4)创建接口实例<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">target=Substitute.For&lt;IPerson&gt;();<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">5)测试属性的读写操作<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">target.Name.Returns("小明");<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">//测试属性的读操作<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">Assert.AreEqual(target.Name,"小明");<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">//对属性进行写操作<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">target.Name="王二";<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">Assert.AreEqual(target.Name,"王二");<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0">还可以使用Returns（）设置的多个返回值序列<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">target.Name.Returns("A","B","C");<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">Assert.AreEqual(target.Name,"A");<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">Assert.AreEqual(target.Name,"B");<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">Assert.AreEqual(target.Name,"C");<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; text-indent: -21.25pt; margin-bottom: 0pt; margin-left: 21.25pt" class="p0">6)测试事件<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">booleventWasRaised=false;<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">//定义委托事件<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">target.Sleep+=(sender,args)=&gt;eventWasRaised=true;<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">//触发事件<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">target.Sleep+=Raise.Event();<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">//断言事件被触发<o:p></o:p></p><p style="text-align: left; line-height: 150%; margin-top: 0pt; margin-bottom: 0pt;background: rgb(245,245,245); word-break: break-all" class="p0">Assert.IsTrue(eventWasRaised);<o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p style="line-height: 150%; margin-top: 0pt; margin-bottom: 0pt" class="p0"><o:p></o:p></p><p><!--EndFragment--></p>

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>