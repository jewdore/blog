---
layout: post
title: 第三节 MongoDB插入和批量插入，插入原理
---

<p>  在开发之前，选择MongoDb驱动是件很重要的事情。如果选择不好，在后期的开发的是件很费力的事情，因为我就遇到这样的问题。MongoDb驱动有几种比较流行驱动，官方驱动和samus是两种使用比较多的。 </p><p> 好了，接着说今天的内容了。 首先从MongoDb的官方网站上下载CSharp驱动(https://github.com/mongodb/mongo-csharp-driver/downloads)。我使用的是CSharpDriver-1.1.0.4184,里面还包含一个CSharpDriverDocs.chm的文档。 MongoDb插入原理：使用驱动程序进行插入的时候，会将数据转换成BSON格式。数据库会解析BSON，并检验是否含有&#8220;_id&#8221;键，因为&#8220;_id&#8221;键在插入到数据库时MongoDb会自动生成。而且每次插入文档不能超过4M。这个应该是和MongoDb本身有关。但是MongoDb1.8版本的支持16M，为什么是这个样子我到没怎么研究。这个想留给有心人帮忙解决下了。</p><p> 插入的Shell操作有Insert和Save两种语法，先看下面的Shell</p><p>&gt; var time = new Date("2011/8/28 21:50:00") //定义一个时间对象&gt; var i = {"time":time,"userid":10001,"sessionid":"20110829215100","ip":"192.168.0.1","title":"Login","url":"Login.aspx"} //定义一个文档对象&gt; i //查看 i 文档{ "time" : ISODate("2011-08-28T13:50:00Z"), "userid" : 10001, "sessionid" : "20110829215100", "ip" : "192.168.0.1", "title" : "Login", "url" : "Login.aspx"}&gt; use testDb&gt; show collections //查看当前集合，把i文档插入到login集合中mycmyc1myc2system.indexes&gt; db.login.insert(i)&gt; db.login.findOne(){ "_id" : ObjectId("4e5b99e62690d28cadd0f58d"), //MongoDb会为每个插入的对象自动生成一个"_id"的值，你可以在插入的时候自己指定这个值,如下面 "time" : ISODate("2011-08-28T13:50:00Z"), "userid" : 10001, "sessionid" : "20110829215100", "ip" : "192.168.0.1", "title" : "Login", "url" : "Login.aspx"}&gt; i = {"_id":"newid_100001","time":time,"userid":10001,"sessionid":"20110829215100","ip":"192.168.0.1","title":"Login","url":"Login.aspx"}{ "_id" : "newid_100001", "time" : ISODate("2011-08-28T13:50:00Z"), "userid" : 10001, "sessionid" : "20110829215100", "ip" : "192.168.0.1", "title" : "Login", "url" : "Login.aspx"}&gt; db.login.save(i) //这里用save插入文档到数据库&gt; db.login.find() //查询结果两条文档，第二条文档"_id"是自定义的值{ "_id" : ObjectId("4e5b99e62690d28cadd0f58d"), "time" : ISODate("2011-08-28T13:50:00Z"), "userid" : 10001, "sessionid" : "20110829215100","ip" : "192.168.0.1", "title" : "Login", "url" : "Login.aspx" }{ "_id" : "newid_100001", "time" : ISODate("2011-08-28T13:50:00Z"), "userid" : 10001, "sessionid" : "20110829215100", "ip" : "192.168.0.1","title" : "Login", "url" : "Login.aspx" }</p><p>注意：1:Insert和Save的区别是：如果插入的集合的&#8220;_id&#8221;值，在集合中已经存在,用Insert执行插入操作回报异常，已经存在"_id"的键。用Save如果系统中没有相同的"_id"就执行插入操作，有的话就执行覆盖掉原来的值。相当于修改操作。我这里就不做演示了。</p><p>下面说下用C#驱动 添加文档。</p><p>2:在新建一个集合或者一个数据库时，MongoDb不会在马上生成。而是在你添加了第一个数据后才会有显示。这个特性很多的数据库都用，比如说SQLite。</p><p>下面说下用 C#驱动 添加文档</p>C#驱动 添加文档 1#regionVersionInfo2/*========================================================================3*【说明描述】4*5*作者：yoolo时间：2011/8/2921:15:386*文件名：NoSpiderAuto.LoginDemo7*版本：V1.0.18*9*修改者：时间：10*修改说明：11*========================================================================12*/13#endregion1415namespaceNoSpiderAuto16{17usingSystem;18usingSystem.Collections.Generic;19usingSystem.Linq;20usingSystem.Text;21usingMongoDB.Driver;22usingMongoDB.Bson;2324internalclassLoginDemo25{26MongoDatabasedb;27MongoCollectioncoll;28publicLoginDemo()29{30MongoServerSettingsset=newMongoServerSettings()31{32Server=newMongoServerAddress("127.0.0.1")33};34MongoServerserver=newMongoServer(set);35db=server.GetDatabase("testDb");36coll=db.GetCollection("login");37}3839///&lt;summary&gt;40///单个对象插入41///&lt;/summary&gt;42publicvoidInsertLogin()43{44varTime=DateTime.Now.ToUniversalTime();4546//实例一添加匿名对象47varlogin=new{_id="newid_100002",time=Time,userid=10002,sessionid="20110829215102",ip="192.168.0.2",title="注册",url="Register.aspx"};48coll.Insert(login);//插入成功4950//添加一个BsonDocument对象51BsonDocumentdoc=newBsonDocument();52doc.Add("_id",BsonValue.Create("newid_100003"));53doc.Add("time",BsonValue.Create(Time));54doc.Add("userid",BsonValue.Create(10003));55doc.Add("sessionid",BsonValue.Create("20110829215103"));56doc.Add("ip",BsonValue.Create("192.168.0.3"));57doc.Add("title",BsonValue.Create("注册"));58doc.Add("url",BsonValue.Create("Register.aspx"));59coll.Insert(doc);//插入成功6061//添加一个对象62Loginman=newLogin();63man._id="newid_100004";64man.time=Time;65man.userid=10004;66man.sessionid="20110829215104";67man.ip="192.168.0.4";68man.title="注册";69man.url="Register.aspx";70coll.Insert(man);//插入成功7172}73///&lt;summary&gt;74///批量插入75///&lt;/summary&gt;76publicvoidInsertBatchLogin()77{78varTime=DateTime.Now.ToUniversalTime();79List&lt;Login&gt;logins=newList&lt;Login&gt;();8081for(inti=0;i&lt;100;i++)82{83Loginman=newLogin();84man._id="newid_100001"+i.ToString();//_id在批量插入的时候不能重复，如果有一个重复全部集合无法插入到集合85man.time=Time;86man.userid=10004+i;87man.sessionid="20110829215104";88man.ip="192.168.0.4";89man.title="注册";90man.url="Register.aspx";91logins.Add(man);92}93coll.InsertBatch(typeof(Login),logins);//插入成功94}95}9697publicclassLogin98{99publicstring_id{get;set;}100publicDateTimetime{get;set;}101publicintuserid{get;set;}102publicstringsessionid{get;set;}103publicstringip{get;set;}104publicstringtitle{get;set;}105publicstringurl{get;set;}106}107}

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>