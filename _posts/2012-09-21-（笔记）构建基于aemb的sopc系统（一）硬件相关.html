---
layout: post
title: （笔记）构建基于aemb的sopc系统（一）--硬件相关
---

<p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">The world's smallest and fastest multi-threaded 32-bit RISC microprocessor core family！</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; text-align: justify; ">AEMB是高速，开源，嵌入式微处理器核的一个系列。它有几种版本：single-threaded核，double-threaded核和quad-threaded核。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; text-align: justify; ">AEMB的特性</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 42pt; text-align: justify; ">&#216;Small and fast</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 42pt; text-align: justify; ">&#216;Multi-threaded</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 42pt; text-align: justify; ">&#216;Open-source</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 42pt; text-align: justify; ">&#216;Wishbone-compliant</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 42pt; text-align: justify; ">&#216;Parameterisable</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 42pt; text-align: justify; ">&#216;Mature</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">关于AEMB Architecture需注意：While being C/C++ compatible, there are several different versions of the core with different architectures, not just different EDK compatibilities. When deciding which version to use for your application, you should attemptto use the latest core as the older ones are generally not supported.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">阅读AEMB的老文档可以访问<u>http://www.aeste.my/node/</u><u>n</u>，n=1,11~23。可以看到不少有用的东西。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">获得AEMB的编译工具链和RTL源码。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">在<u>AEMB</u>的网站上找不到编译工具链的源码了，在opencores上mb-gcc的链接也无效了，不过在<u>AEMB</u>网站上提供了已编译好的CROSS-COMPILERS，并且提醒到：they were hard to locate elsewhere.但在中国这个大局域网里直接下载是下不到的，通过代理吧。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">后记：可以到<u>Xilinx</u>网页上用注册的用户下载编译源码。可以参考<u>How to build a GCC toolchain for the AEMB</u>，编译工具链（较老了2007-12-06），有时间做一下。参考<u>如何为</u><u>aeMB RISC processor</u><u>编译固件？</u>（可能较新）。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">RTL的源码在opencores网站上就可以找到<u>aemb_latest.tar.gz</u>。在/sw/gccrom文件中给出了一个编译代码的样本脚本。编译一个基本的程序，只需用到：</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; background-color: #a6a6a6; text-align: justify; ">$ mb-gcc -g -Os -mxl-barrel-shift -mno-xl-soft-mul -specs=aemb.specs -o rom.elf</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">这句代码将产生rom.elf文件，它可以转存（dump）成适用于仿真（simulation），烧写存储器（flashing into memory）和集成到比特流（integration into configuration）的各种格式。编译的过程中有很多可以配置的命令行选项。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 42pt; ">&#216;-mno-xl-soft-mulshould be specified if the AEMB is configured with a hardware multiplier.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 42pt; ">&#216;-mxl-barrel-shiftshould be specified if the AEMB is configured with a hardware barrel shifter.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 42pt; ">&#216;-specs=aemb.specsspecifies the custom specs file to use, which is customised below.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">创建specs文件，可以用以下的命令</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; background-color: #a6a6a6; text-align: justify; ">$ mb-gcc -dumpspecs &gt; aemb.specs</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">然后再根据自己的需求修改aemb.specs文件。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">读一下aemb的blog<u>http://blog.aeste.my/</u></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">整数流水线</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Instruction Fetch (IF)The instruction address is presented to the instruction cache and the pipeline is stalled until the request is fulfilled by the instruction cache.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Operand Fetch (OF)The operands are fetched from the register file.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Instruction Execution (EX)The instruction is decoded and executed by the appropriate execution unit.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Memory Access (MA)Any external data access is performed in this stage, which includes data memory access and accelerator bus access. There is no built in data cache.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Write Back (WB)All integer data processed is written back into the register file in this stage. Branch instructions will also write to the programme counter at this stage.</p><h3 style="font-size: 12pt; margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">Architecture Summary（EDK62）<p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;5-stage integer execution pipeline.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Sixty four 32-bit general purpose registers.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;32-bit instruction length with 2 addressing modes and 3 operands.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Three 32-bit Wishbone buses - instruction, data, accelerator.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Integrated FPGA oriented instruction cache.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Multi-stage hardware multiplier.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Multi-stage barrel-shifter.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Single issue pipeline.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 21pt; ">&#216;Dual hardware threads.</p><h3 style="font-size: 12pt; margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; "><h3 style="font-size: 12pt; margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">Eyecandy on a Chip<p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">这是个什么东西？<u>milkymist</u>，好像是有关视频渲染的一个aemb的应用。下载源码</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; background-color: #a6a6a6; text-align: justify; ">$ git clone http://github.com/lekernel/milkymist.git</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">这个工程不小。有64M之大。是ISE的工程。Xilinx的开发板，芯片Virtex-4。不懂。演示视频<u>mm03_demo.mp4</u>非常炫。这小小的aemb还能做这等事？</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">后记：在<u>milkymist</u>的blog中发现了这么一句：Early versions of the system-on-chip used AEMB instead of Mico32. It has been replaced because of performance and software support complexity reasons.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">可在AEMB的网站上还贴着：As you can see from the system block diagram on the right, the powerful system-on-chip uses the AEMB as its core processor.其实人家已经不用了。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">不过这个<u>milkymist</u>可真是个非常不错的工程。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">又一个aemb的工程<u>OpenPattern OMRP</u>不可访问。Site under maintenance</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">后记：终于找到了一个可以得到的用到了aemb的参考工程：USRP and USRP2</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; background-color: #a6a6a6; text-align: justify; ">git clone git://git.ettus.com/ettus/fpga.git</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">被下一代的GNU Radio工程选为中央处理器，GNU Radio是免费软件开发套件，提供了信号实时处理的软件和低成本的软件无线电硬件。被广泛应用于业余爱好者，学术研究以及商业环境中去支持无线通讯的学术研究以便去真实实现无线电系统。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">aemb源码中附带的《AEMB 32-bit Microprocessor Core Datasheet》内容比较少，且较老了吧。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">The core ports are broken into four groups: Instruction Bus, DataBus, FSL Bus and System signals.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">External signal names and descriptions.</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; ">顶层文件说是EDK32，其实在最新版的里的顶层文件有aemb_core，aemb2_edk62，aemb2_edk63。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; text-align: justify; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; text-align: justify; ">复位操作</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; text-align: justify; ">Aemb核的复位信号是SYS_RST_I。在复位时，所有核的内部寄存器，被置位成它们的复位值，所有的中断被MSR_IE寄存器的值禁止。复位后，处理器从0x00000000开始取指。</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; text-align: justify; "></p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; text-align: justify; ">中断操作（Interrupt Operation）</p><p style="margin-top: 0pt; margin-right: 0pt; margin-bottom: 0pt; margin-left: 0pt; text-align: justify; ">Aemb核支持SYS_INT_I信号上升沿出发的复位信号，中断反应时间3~5个时钟周期。Interrupts will not trigger between non-atomic instructions suchas IMMI.</p>

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>