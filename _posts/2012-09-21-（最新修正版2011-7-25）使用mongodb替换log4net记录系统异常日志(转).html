---
layout: post
title: （最新修正版2011-7-25）使用MongoDB替换Log4net记录系统异常日志(转)
---

<p>http://www.cnblogs.com/skyaspnet/archive/2011/03/22/1989969.html</p><p>自上次修改后日志系统已经稳定运行了23天</p><p>说明： 日志系统运行了一段时间以后，出现了几次mongodb服务无法启动的问题，删除data目录下的mongod.lock后才能成功重启服务，</p><p>初步判断资源发生了死锁，因此将 using (Mongo mongo =new Mongo(config.BuildConfiguration())) 写法修改为 try catch 形式，</p><p>修改之后系统正常运行十天，但是在6月29日再次发现mongodb服务无法正常启动的问题，再次将 Mongo类中插入记录的方法改为使用 mongo.Insert，</p><p>重新更新至服务器，效果有待进一步观察，希望遇到并成功解决这个问题的朋友能一起交流讨论这个问题，谢谢！</p><p>PS: 1. 更改了Mongodb数据库字符串连接方式，由 Server=127.0.0.1:6111 更改为 mongodb://127.0.0.1:6111</p><p>   2. 升级Mongodb版本，由Windows 64位 1.8.0版本升级为Windows 64位 1.8.2 (版本升级可能也解决了存在的BUG)</p><p>   由于对系统中日志记录模块使用Log4net 不太满意，最大的原因可能就是觉得它的文本记录模式很不好用，</p><p>查看也不方便，当然它也可以使用sqlite、access、系统事件等方式来记录，但是总觉得不是那么尽如人意，</p><p>因此想到使用MongoDB来完成这一工作，测试环境为win7、vs2010、.net framework 4.0 详细记录如下：</p><p>1. 首先在官方网站下载最新版本的MongoDBhttp://www.mongodb.org/downloads</p><p> 在下载列表里选择适合你的版本，由于服务器是Windows Server 2008 R2 64位， 因此选择了Windows 64 bit版本。</p><p>2. MongoDB的安装</p><p> MongoDB的安装非常简单，首先将下载后的压缩包解压至任意目录，假定为d:\mongodb，在cmd窗口中进入d:\mongodb\bin目录，</p><p>输入：</p><p>mongod --dbpath d:\mongodb\data --logpath d:\mongodb\logs\mongodb.log --logappend --directoryperdb--bind_ip 127.0.0.1 --port 6111 --install</p><p>然后执行，正常情况如下图，如出现安装错误，请检查文件权限并手工建立 dbpath目录与logpath目录：</p><p>再执行 net start "MongoDB" 即可启动服务。</p><p>有关于安装参数的说明：</p><p>--dbpath 是数据文件所在目录</p><p>--logpath 是日志文件所在文件路径，此参数必须为文件，不能为文件目录，否则会导致安装失败</p><p>以上两个参数必须设置</p><p>--logappend 日志以追加的方式写入</p><p>--directoryperdb 为每个数据库建立单独的目录</p><p>--bind_ip 绑定服务器IP，此参数为安全起见建议使用127.0.0.1，因为如果不设置的话，远程是可以连接的</p><p>--port 端口号</p><p>--install 以服务形式安装</p><p>如果需要删除 MongoDB 服务请使用 mongod --remove</p><p>3. MongoDB C#客户端的选择</p><p>客户端的选择原则自然是以谁强大、开源、更新快就选谁，因此选择mongodb-csharp， git地址为：</p><p>https://github.com/samus/mongodb-csharp</p><p>下载后可以使用vs2010或者是vs2008打开程序，并生成我们所需要的MongoDB.dll，我们的程序中将会引用它</p><p>此外，在mongodb-csharp程序中我们还可以找到分别用C#和VB.NET制作的两个Sample，可以帮助我们理解一些基本操作，示例程序注释说明如下：</p>View Code //定义MongoDB配置生成器            var config =new MongoConfigurationBuilder();            // 设置映射关系            config.Mapping(mapping =&gt;            {                mapping.DefaultProfile(profile =&gt;                {                    profile.SubClassesAre(t =&gt; t.IsSubclassOf(typeof(MyClass)));                });                mapping.Map&lt;MyClass&gt;();                mapping.Map&lt;SubClass&gt;();            });            //设置访问字符串，相当于SQL SERVER的连接字符串            config.ConnectionString("Server=127.0.0.1:6111");            //实例化一个Mongo操作类，用于完成对MongoDB的操作using (Mongo mongo =new Mongo(config.BuildConfiguration()))            {                //连接                mongo.Connect();                try                {                    //选择要使用的database，如果没有会自动建立                    var db = mongo.GetDatabase("TestDb");                    //获取TestDb所有表中类型为MyClass的记录集合                    var collection = db.GetCollection&lt;MyClass&gt;();                    MyClass square =new MyClass()                    {                        Corners =4,                        Name ="Square"                    };                    MyClass circle =new MyClass()                    {                        Corners =0,                        Name ="Circle"                    };                    SubClass sub =new SubClass()                    {                        Name ="SubClass",                        Corners =6,                        Ratio =3.43                    };                    collection.Save(square);                    collection.Save(circle);                    collection.Save(sub);                    //使用Linq方式进行读取                    var superclass = (from item in db.GetCollection&lt;MyClass&gt;("MyClass").Linq()                                where item.Corners &gt;1                                select item.Corners).ToList();                    var subclass = (from item in db.GetCollection&lt;SubClass&gt;("MyClass").Linq()                                    where item.Ratio &gt;1                                    select item.Corners).ToList();                    Console.WriteLine("Count by LINQ on typed collection: {0}", collection.Linq().Count(x =&gt; x.Corners &gt;1));                    Console.WriteLine("Count by LINQ on typed collection2: {0}", db.GetCollection&lt;SubClass&gt;().Linq().Count(x =&gt; x.Corners &gt;1));                    //Console.WriteLine("Count by LINQ on typed collection3: {0}", db.GetCollection&lt;SubClass&gt;().Count(new { Corners = Op.GreaterThan(1) }));                    Console.WriteLine("Count on typed collection: {0}", collection.Count(new { Corners = Op.GreaterThan(1) }));

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>