---
layout: post
title: RabbitMQ用户指南（RabbitMQ-C）
---

<h1 id="RabbitMQ用户指南（RabbitMQ-C）-RabbitMQ-C客户端使用说明">RabbitMQ-C客户端使用说明<p>rabbitmq-c是一个用于C语言的，与AMQP server进行交互的client库，AMQP协议为版本0-9-1。rabbitmq-c与server进行交互前需要首先进行login操作，在操作后，可以根据AMQP协议规范，执行一系列操作。</p><p>这里，根据项目需求，只进行部分接口说明，文后附demo的github地址。</p><p>接口描述：</p><p>amqp_connection_state_t amqp_new_connection(void);</p><p>  接口说明：声明一个新的amqp connection</p><p>int amqp_open_socket(char const *hostname,int portnumber);</p><p>  接口说明：获取socket.</p><p>  参数说明：hostname     RabbitMQ server所在主机</p><p>         portnumber   RabbitMQ server监听端口 </p><p>void amqp_set_sockfd(amqp_connection_state_t state,int sockfd);</p><p>  接口说明：将amqp connection和sockfd进行绑定</p><p>amqp_rpc_reply_t amqp_login(amqp_connection_state_t state,char const *vhost,int channel_max,int frame_max,int heartbeat,amqp_sasl_method_enum sasl_method, ...);</p><p>  接口说明：用于登录RabbitMQ server，主要目的为了进行权限管理；</p><p>  参数说明：state  amqp connection</p><p>         vhost  rabbit-mq的虚机主机，是rabbit-mq进行权限管理的最小单位</p><p>         channel_max 最大链接数，此处设成0即可</p><p>         frame_max 和客户端通信时所允许的最大的frame size.默认值为131072，增大这个值有助于提高吞吐，降低这个值有利于降低时延</p><p>         heartbeat 含义未知，默认值填0</p><p>         sasl_method 用于SSL鉴权，默认值参考后文demo</p><p>amqp_channel_open_ok_t *amqp_channel_open(amqp_connection_state_t state, amqp_channel_t channel);</p><p>  接口说明：用于关联conn和channel</p><p>amqp_exchange_declare_ok_t *amqp_exchange_declare(amqp_connection_state_t state, amqp_channel_t channel, amqp_bytes_t exchange, amqp_bytes_t type, amqp_boolean_t passive, amqp_boolean_t durable, amqp_table_t arguments);</p><p>  接口说明：声明declare</p><p>  参数说明：state</p><p>         channel</p><p>         exchange</p><p>         type   "fanout" "direct" "topic"三选一</p><p>         passive</p><p>         curable</p><p>         arguments</p><p>amqp_queue_declare_ok_t *amqp_queue_declare(amqp_connection_state_t state, amqp_channel_t channel, amqp_bytes_t queue, amqp_boolean_t passive, amqp_boolean_t durable, amqp_boolean_t exclusive, amqp_boolean_t auto_delete, amqp_table_t arguments);</p><p>  接口说明：声明queue</p><p>  参数说明：state  amqp connection</p><p>         channel</p><p>         queue queue name</p><p>         passive</p><p>         durable 队列是否持久化</p><p>         exclusive 当前连接不在时，队列是否自动删除</p><p>         aoto_delete 没有consumer时，队列是否自动删除</p><p>         arguments 用于拓展参数，比如x-ha-policy用于mirrored queue</p><p>amqp_queue_bind_ok_t *amqp_queue_bind(amqp_connection_state_t state, amqp_channel_t channel, amqp_bytes_t queue, amqp_bytes_t exchange, amqp_bytes_t routing_key, amqp_tab le_t arguments);</p><p>  接口说明：声明binding  </p><p>amqp_basic_qos_ok_t *amqp_basic_qos(amqp_connection_state_t state, amqp_channel_t channel, uint32_t prefetch_size, uint16_t prefetch_count, amqp_boolean_t global);</p><p>  接口说明：qos是 quality of service，我们这里使用主要用于控制预取消息数，避免消息按条数均匀分配，需要和no_ack配合使用</p><p>  参数说明：state</p><p>         channel</p><p>         prefetch_size 以bytes为单位，0为unlimited</p><p>         prefetch_count 预取的消息条数</p><p>         global</p><p>amqp_basic_consume_ok_t *amqp_basic_consume(amqp_connection_state_t state, amqp_channel_t channel, amqp_bytes_t queue, amqp_bytes_t consumer_tag, amqp_boolean_t no_local, amqp_boolean_t no_ack, amqp_boolean_t exclusive, amqp_table_t arguments);</p><p>  接口说明：开始一个queue consumer</p><p>  参数说明：state</p><p>         channel</p><p>         queue</p><p>         consumer_tag</p><p>         no_local</p><p>         no_ack  是否需要确认消息后再从队列中删除消息</p><p>         exclusive</p><p>         arguments</p><p>int amqp_basic_ack(amqp_connection_state_t state,amqp_channel_t channel,uint64_t delivery_tag,amqp_boolean_t multiple);</p><p>          </p><p>int amqp_basic_publish(amqp_connection_state_t state,amqp_channel_t channel,amqp_bytes_t exchange,amqp_bytes_t routing_key,amqp_boolean_t mandatory,amqp_boolean_t immediate,struct amqp_basic_properties_t_ const *properties,amqp_bytes_t body);</p><p>  接口说明：发布消息</p><p>  参数说明：state</p><p>         channel</p><p>         exchange </p><p>         routing_key 当exchange为默认&ldquo;&rdquo;时，此处填写queue_name，当exchange为direct，此处为binding_key</p><p>         mandatory 参见参考文献2</p><p>         immediate 同上</p><p>         properties 更多属性，如何设置消息持久化，参见文后demo</p><p>         body 消息体</p><p>amqp_rpc_reply_t amqp_channel_close(amqp_connection_state_t state,amqp_channel_t channel,int code);</p><p>amqp_rpc_reply_t amqp_connection_close(amqp_connection_state_t state,int code);</p><p>int amqp_destroy_connection(amqp_connection_state_t state);</p><p>如何consume消息，参见文后demo。</p><h1 id="RabbitMQ用户指南（RabbitMQ-C）-demo">demo<p>https://github.com/liuhaobupt/rabbitmq_work_queues_demo-with-rabbit-c-client-lib</p><p>其中 rmq_new_task.c和rmq_worker.c对应于RabbitMQ tutorial里的work queues章节(http://www.rabbitmq.com/tutorials/tutorial-two-python.html)，emit_log_direct.c和receive_logs_direct.c对应于RabbitMQ tutorial里的routing章节（http://www.rabbitmq.com/tutorials/tutorial-four-python.html），这两个demo覆盖了RabbitMQ的常用应用场景。</p><p>编译需要librabbitmq.a库，同时需要rabbitmq-c提供的几个头文件（amqp.h和amqp_framing.h）以及utils.c文件，这些在github project页面均可获得。</p><h1 id="RabbitMQ用户指南（RabbitMQ-C）-参考文献">参考文献<ol>rabbitmq-c主页http://hg.rabbitmq.com/rabbitmq-c/summaryhttp://www.rabbitmq.com/amqp-0-9-1-reference.html</ol>

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>