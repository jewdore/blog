---
layout: post
title: 使用MongoDB的支持Linq 驱动NoRM
---

<p>MongoDB的驱动有好几个，分布式文件存储的数据库开源项目MongoDB里使用的是github.com/samus/mongodb-csharp，monogodb-csharp不是强类型，使用起来不方便。转向使用支持强类型访问MongoDB的NoRM C# driver。NoRM 驱动和MongoDB-CSharp的一个区别的地方就是NoRM使用强类型的类操作MongoDB-CSharp的Document类。</p>  <p>使用NoRM很简单，引用NoRM.dll就可以了，下面的例子是一个控制台程序：</p>  <p> </p>  <p>模型类，代表保存到数据库的数据</p>  <p>using System;   using System.Collections.Generic;    using System.Linq;    using System.Text;    using Norm; </p>  <p>namespace FirstMongoDb   {    &#160;&#160;&#160; public class Customer: IHaveIdentifier    &#160;&#160;&#160; {    &#160;&#160;&#160;&#160;&#160;&#160;&#160; public ObjectId _id { get; set; }    &#160;&#160;&#160;&#160;&#160;&#160;&#160; public string Name { get; set; }    &#160;&#160;&#160;&#160;&#160;&#160;&#160; public DateTime LastOrderUtc { get; set; }    &#160;&#160;&#160;&#160;&#160;&#160;&#160; public List&lt;string&gt; OrderedItems { get; set; } </p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; public Customer()   &#160;&#160;&#160;&#160;&#160;&#160;&#160; {    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; OrderedItems = new List&lt;string&gt;();    &#160;&#160;&#160;&#160;&#160;&#160;&#160; }    &#160;&#160;&#160; }    }</p>  <p>这个足够简单了，下面我们连到数据库</p>  <p>public class MongoDbDataContext : IDisposable   &#160;&#160;&#160; {    &#160;&#160;&#160;&#160;&#160;&#160;&#160; private readonly MongoQueryProvider provider; </p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; public MongoQueryProvider Provider   &#160;&#160;&#160;&#160;&#160;&#160;&#160; {    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; get { return provider; }    &#160;&#160;&#160;&#160;&#160;&#160;&#160; } </p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; public static string DatabaseName { get; set; } </p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; public MongoDbDataContext()   &#160;&#160;&#160;&#160;&#160;&#160;&#160; {    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if ( string.IsNullOrEmpty( DatabaseName ) )    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; throw new InvalidOperationException( &quot;You must set the static DatabaseName property.&quot; );    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; provider = new MongoQueryProvider(    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; new Mongo( DatabaseName, &quot;127.0.0.1&quot;, &quot;27017&quot;, null ) );    &#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>  <p>使用NoRM去冬连接到数据需要提供一个数据库名，服务器地址和端口，参看上述红色代码。</p>  <p>插入一个对象到数据库</p>  <p>private static void Insert()   &#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Customer c = new Customer();   &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; c.Name = &quot;Jake&quot;;    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; c.LastOrderUtc = DateTime.UtcNow;    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; c.OrderedItems.Add(&quot;frappa&quot;);    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; c.OrderedItems.Add( &quot;beer&quot; );    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; c.OrderedItems.Add( &quot;redbull!&quot; );    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; c.OrderedItems.Add( &quot;wings&quot; ); </p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; using ( MongoDbDataContext ctx = new MongoDbDataContext() )   &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctx.Add(c);    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }    &#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>  <p>使用LINQ查询数据库</p>  <p>using ( MongoDbDataContext ctx = new MongoDbDataContext() )    {    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; var query =    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; from c in ctx.Customers    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; where c.Name == &quot;Michael&quot;    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; orderby c.LastOrderUtc descending    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; select c; </p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; foreach (var customer in query)   &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Console.WriteLine(&quot;{0} bought {1}&quot;,    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; customer.Name,    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; customer.OrderedItems.FirstOrDefault()    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; );    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }    &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>  <p>&#160;</p>  <p>参考：Using MongoDB with the NoRM driver</p>

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>