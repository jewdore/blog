---
layout: post
title: Android推送消息指南
---

<p>从服务器向客户端推送各种通知消息，iPhone已经有比较简单和完美的推送消息的解决方案，Android推送消息的方法。</p>  <p>&#160;</p>  <p>除了Google 的C2DM外，下面是几种其他的方案：</p>  <p>1.轮询：应用程序阶段性的与服务器进行连接并查询是否有新的消息到达，你必须自己实现与服务器之间的通信，例如消息排队等，轮询的频率。</p>  <p>2.SMS：拦截SMS消息，并且解析消息内容来了解服务器的意图，成本较高，很难找到免费的短消息网关。</p>  <p>3.持久连接：Android操作系统允许低内存的情况下杀死系统服务。</p>  <p>&#160;</p>  <p>&#160;</p>  <p>1.采用MQTT协议实现Android推送</p>  <p>MQTT是一个轻量级的消息发布/订阅协议，</p>  <p>客户端：https://github.com/tokudu/AndroidPushNotificationsDemo</p>  <p>服务器：https://github.com/tokudu/PhpMQTTClient‘</p>  <p>&#160;</p>    <p>&#160;</p>  <p>wmqtt.jar是IBM提供的MQTT协议的实现，下载地址</p>  <p>http://www-01.ibm.com/support/docview.wss?rs=171&amp;uid=swg24006006</p>  <p>将该Jar包加入到自己的应用程序中。</p>  <p>&#160;</p>  <p>&#160;</p>  <p>Really Small Message&#160; Broker,是一个简单的MQTT代理，同样由IBM提供，缺省打开1883端口，它负责接收服务器的消息并将其转发给指定的移动设备。SAM是一个针对MQTT写的PHP库，send_mqtt.php是一个通过POST接收消息并且通过SAM将消息发送给RSMB的PHP脚本。</p>  <p>&#160;</p>  <p>可以从GitHub上下载实例应用。运行该应用以后，通过手机浏览器访问http://tokudu.com/demo/android-push/,在第一个输入框输入设备ID，在第二个输入框输入想要发送的消息内容，按下“Send Push Message”按钮，你就应该可以看到手机上收到了通知了。你也可以从这个GitHub地址上下载android-push源代码，它包含了send_mqtt.php脚本。</p>  <p>&#160;</p>    <p>&#160;</p>  <p>&#160;</p>  <p>2.采用XMPP协议实现Android消息推送，XMPP可扩展和表示协议，是基于可扩展标记语言XML的协议，它用于即时消息IM以及在线探测，可能最终允许Internet用户向其他任何人发送即时消息。</p>  <p>&#160;</p>  <p>androidpn是一个基于XMPP协议的java开源Android push notification实现。它包含了完整的客户端和服务器端。经过源代码研究我发现，该服务器端基本是在另外一个开源工程openfire基础上修改实现的，不过比较郁闷的是androidpn的文档是由韩语写的，所以整个研究过程基本都是读源码。它的实现示意图如下：</p>  <p>&#160;</p>    <p>&#160;</p>  <p>&#160;</p>  <p>androidpn客户端需要用到一个基于java的开源XMPP协议包asmack，这个包同样也是基于openfire下的另外一个开源项目smack，不过我们不需要自己编译，可以直接把androidpn客户端里面的asmack.jar拿来使用。客户端利用asmack中提供的XMPPConnection类与服务器建立持久连接，并通过该连接进行用户注册和登录认证，同样也是通过这条连接，接收服务器发送的通知。</p>  <p>androidpn服务器端也是java语言实现的，基于openfire开源工程，不过它的Web部分采用的是spring框架，这一点与openfire是不同的。Androidpn服务器包含两个部分，一个是侦听在5222端口上的XMPP服务，负责与客户端的XMPPConnection类进行通信，作用是用户注册和身份认证，并发送推送通知消息。另外一部分是Web服务器，采用一个轻量级的HTTP服务器，负责接收用户的Web请求。服务器架构如下：</p>    <p>最上层包含四个组成部分，分别是SessionManager，Auth Manager，PresenceManager以及Notification Manager。SessionManager负责管理客户端与服务器之间的会话，Auth Manager负责客户端用户认证管理，Presence Manager负责管理客户端用户的登录状态，NotificationManager负责实现服务器向客户端推送消息功能。</p>  <p>服务器端界面如下，分别对应了上述的几个功能模块：</p>          <p>发送以后，我们可以在手机端看到接收的消息：</p>    <p>这个解决方案的最大优势就是简单，我们不需要象C2DM那样依赖操作系统版本，也不会担心某一天Google服务器不可用。利用XMPP协议我们还可以进一步的对协议进行扩展，实现更为完善的功能。</p>  <p>采用这个方案，我们目前只能发送文字消息，不过对于推送来说一般足够了，因为我们不能指望通过推送得到所有的数据，一般情况下，利用推送只是告诉手机端服务器发生了某些改变，当客户端收到通知以后，应该主动到服务器获取最新的数据，这样才是推送服务的完整实现。</p>

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>