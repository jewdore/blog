---
layout: post
title: MonoTouch绑定CocoaTouch类库
---

绑定概述 <p>在 Windows/Linux 平台上， .Net/Mono 可以通过平台调用 (P/Invoke) 技术调用本地类库， 通过互操作 (Interop) 技术调用 COM 组件， 在 iOS 平台上， MonoTouch 也有类似的技术， 可以调用 iOS 的 CocoaTouch 类库， 这种技术在 MonoTouch 叫做绑定 (Binding) ， 整个 monotouch.dll 就是用绑定技术完成的。</p><p>互联网上有很多热心网友提供的 CacoaTouch 类库， 如果想使用这些类库， 完全用 C# 重写是不可取的， 所以就要用到 MonoTouch 的绑定技术。</p>  <p>绑定技术听起来高深， 其实仔细研究起来， 其实并不难。 接下来， 以 KKGridView 为例， 说明怎样绑定 CocoaTouch 类库项目。</p>准备 MonoTouch 绑定项目<p>新建一个名称为 KKGridView 的空白解决方案， 作为工作区， 再新建一个绑定项目， 名称为 Binding ， 项目建好之后， 设置绑定项目的默认命名空间为 MonoTouch.KKGrid ， 并设置项目的输出为 KKGridView ， 相关截图如下：</p><p>绑定项目默认结构如下， 包含两个文件： ApiDeginition.cs 和 StructsAndEnums.cs ， 其中 ApiDefinition 用于绑定 CacoaTouch 类库定义的 interface 、 delegate 与 protocol 及其成员， 而 StructsAndEnums 用于绑定 ApiDefinition 所需的结构、 枚举以及其它。 这两个文件的编译方式是不同的， 所以对应的 C# 类型必须对号入座才行。</p>  获取 KKGridView 源代码并编译 <p>KKGridView 在 GitHub 上的主页是 https://github.com/kolinkrewinkel/KKGridView.git ， 使用 git 可以轻松获取其源代码。 打开一个命令行窗口， 切换到绑定项目目录， 输入下面的命令：</p> <pre class="brush: perl">git clone https://github.com/kolinkrewinkel/KKGridView.git</pre> <p>等命令行运行完毕， 源代码就获取好了， 接下来要编译 KKGridView ， 接着输入下面的命令：</p>  <pre class="brush:perl">cd KKGridViewxcodebuild -project KKGridView.xcodeproj -target KKGridView -sdk iphonesimulator -configuration Release clean buildxcodebuild -project KKGridView.xcodeproj -target KKGridView -sdk iphoneos -configuration Release clean buildlipo -create -output libKKGridView.a build/Release-iphonesimulator/libKKGridView.a build/Release-iphoneos/libKKGridView.a</pre><p>现在打开 MonoDevelop 将最终生成的 libKKGridView.a 添加到绑定项目 ， 现在可以开始进行绑定了。</p>绑定 Objective-C 类型至 C#<p>绑定的语法定义为：</p><pre class="brush: csharp">[BaseType(typeof(TypeBase))]interface MyType [: Prodocol1, Protocol2] {   IntPtr Constructor(string foo);}</pre><p>MyType 与 ObjC 的类型对应， TypeBase 与 ObjC 的基类对应， Protocol1 、 Prodocol2 与 ObjC 类型实现的协议对应。</p><p>interface</p><p>ObjC 的 interface 定义如下：</p><pre class="brush: objc">@interface KKGridView : UIScrollView@end</pre><p>对应的绑定语法如下：</p><pre class="brush: csharp">[BaseType(typeof(UIScrollView))]interface KKGridView {}</pre><p>protocol</p><p>ObjC 的 protocol 定义语法如下：</p><pre class="brush: objc">@protocol KKGridViewDataSource &lt;NSObject&gt;@end</pre><p>或者</p><pre class="brush: objc">@protocol KKGridViewDelegate &lt;NSObject , UIScrollViewDelegate&gt;@end</pre><p>ObjC 的 protocol 与 C# 的 interface 有些类似， 但是 protocol 中定义的方法有两种， optional 和 required ， 又有点儿像抽象类， MonoTouch 将其绑定为类， 并添加 ModelAttribute 标记， 对应的绑定语法分别为：</p><pre class="brush: csharp">[Model, BaseType(typeof(NSObject))]interface KKGridViewDataSource {}[Model, BaseType(typeof(UIScrollViewDelegate))]interface KKGridViewDelegate {}</pre><p>instance method</p><p>实例方法绑定为对应的 C# 实例方法：</p><pre class="brush: objc">- (NSString *)gridView:(KKGridView *)gridView titleForHeaderInSection:(NSUInteger)section;</pre><pre class="brush: csharp">[Export(&quot;gridView:titleForHeaderInSection:&quot;)]string GridViewTitleFoHeaderInSection(KKGridView gridView, uint section);</pre><p>如果是 protocol 的 required 方法， 则在对应的 C# 方法上添加 Abstract 标记， 例如：</p><pre class="brush: objc">- (NSUInteger)gridView:(KKGridView *)gridView numberOfItemsInSection:(NSUInteger)section;</pre><pre class="brush: csharp">[Abstract, Export(&quot;gridView:numberOfItemsInSection:&quot;)]uint GridViewNumberOfItemsInSection(KKGridView gridView, uint section);</pre><p>class method</p><p>ObjC 中的 class method 与 C# 中的静态方法概念一致， 因此绑定为 C# 的静态方法， 例如：</p><pre class="brush: objc">+ (id)cellForGridView:(KKGridView *)gridView;</pre><pre class="brush: csharp">[Static, Export(&quot;cellForGridView:&quot;)]KKGridViewCell CellFroGridView(KKGridView gridView);</pre><p>property</p><p>ObjC 的属性通常由 setPropertyName 、 propertyName 两个方法组成， 绑定为 C# 的属性：</p><pre class="brush: objc">@property (nonatomic) BOOL allowsMultipleSelection; </pre><pre class="brush: csharp">[Export(&quot;allowsMultipleSelection&quot;)]bool AllowsMultipleSelection { get; set; }</pre><p>如果不是由默认的两个方法组成， 例如：</p><pre class="brush: objc">@property (nonatomic, getter = isSelected) BOOL selected;</pre><p>对应的绑定为：</p><pre class="brush: csharp">[Export(&quot;selected&quot;)]bool Selected { [Bind(&quot;isSelected&quot;)]get; set; }</pre><p>enum</p><p>枚举的绑定是最容易的， 不过要放在 enums.cs 文件中， 例如：</p><pre class="brush: objc">typedef enum {   KKGridViewAnimationFade,   KKGridViewAnimationResize,   KKGridViewAnimationSlideLeft,   KKGridViewAnimationSlideTop,   KKGridViewAnimationSlideRight,   KKGridViewAnimationSlideBottom,   KKGridViewAnimationExplode,   KKGridViewAnimationImplode,   KKGridViewAnimationNone} KKGridViewAnimation;</pre><pre class="brush: csharp">public enum KKGridViewAnimation {   Fade,   Resize,   SlideLeft,   SlideTop,   SlideRight,   SlideBottom,   Explode,   Implode,   None}</pre>添加 Makefile<pre class="brush: perl"># 定义一些常量PROJECT_ROOT=KKGridViewPROJECT=$(PROJECT_ROOT)/$(PROJECT_ROOT).xcodeprojBUILD_ROOT=$(PROJECT_ROOT)/BuildTARGET=$(PROJECT_ROOT)SDK=lib$(TARGET).aBTOUCH=/Developer/MonoTouch/usr/bin/btouchSMCS=/Developer/MonoTouch/usr/bin/smcsXBUILD=/Developer/usr/bin/xcodebuild# 从github获取源代码$(PROJECT_ROOT):   git clone https://github.com/kolinkrewinkel/$(PROJECT_ROOT).git   cd $(PROJECT_ROOT) &amp;&amp; git pull# 编译模拟器版本simulator: $(PROJECT_ROOT)   mkdir -p libs   $(XBUILD) -project $(PROJECT) -target $(TARGET) -sdk iphonesimulator -configuration Release clean build   mv -f $(BUILD_ROOT)/Release-iphoneSimulator/lib$(TARGET).a ./libs/lib$(TARGET)-simulator.a# 编译设备版本iphoneos: $(PROJECT_ROOT)   mkdir -p libs   $(XBUILD) -project $(PROJECT) -target $(TARGET) -sdk iphoneos -configuration Release clean build   mv -f $(BUILD_ROOT)/Release-iphoneos/lib$(TARGET).a ./libs/lib$(TARGET)-iphoneos.a# 讲两个版本合成为一个sdk:   lipo -create -output $(SDK) libs/lib$(TARGET)-simulator.a libs/lib$(TARGET)-iphoneos.a# 编译 MonoTouch 组件asm:   # 使用 btouch 编译出的 dll 文件总是无法运行， 不知是怎么回事， 只能用 MonoDevelop 进行编译， 所以把这里注释掉了。   #$(BTOUCH) -d=MONOTOUCH -out:bin/$(TARGET).dll api.cs -s:enum.cs --link-with=$(SDK),$(SDK)# 清理clean:   rm -rf $(PROJECT_ROOT) libs ios *.a *.dll *.stamp# 全部任务all: clean simulator iphoneos sdk asm</pre>绑定项目源代码<p>KKGridView 的全部绑定源代码放在 GitHub ， 地址为 https://github.com/beginor/MonoTouch.KKGridView ， 有兴趣的可以围观。</p>

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>