---
layout: post
title: 设计一套基于NHibernate二级缓存的MongoDB组件（上）
---

<p>摘要：NHibernate Contrib 支持很多第三方的二级缓存，如SysCache，MemCache，Prevalence等等，但是没有MongoDB的，于是自己扩展了一个支持MongoDB的缓存组件（NHibernate.Caches.MongoDBCache.dll）。本篇先把组件的源代码开放出来。</p><p>一、背景</p><p> 在NHibernate的Contrib贡献项目官方网站（NHibernateContrib项目是由NHibernate开发团队或者终端用户根据需要自行编译并贡献的一系列的程序）中，拥有一个NHibernate.Caches的项目，里面包含汗多基于NHibernate二级缓存的组件，其中包括有：</p><p>NHibernate.Caches.MemCache：基于memcached分布式存储的缓存组件。这个大家都比较熟悉了就不多说了，详细可查阅相关信息。</p><p>NHibernate.Caches.Prevalence：基于Bamboo.Prevalence的缓存组件。它可产生一系列的缓存目录，通过缓存目录可以从文件中获取数据，并且在缓存目录中通过Snapshot，也就是快照，可以进行断点保存。详细介绍请看我的文章：（在Spring.Net中对于NHibernate.Caches.Prevalence的使用）</p><p>NHibernate.Caches.SharedCache：基于MergeSystem.Indexus.WinServiceCommon、MergeSystem.Indexus.WinService和MergeSystem.Indexus.Notify的分布式存储的缓存组件。用于在动态WEB或Win应用程序中减少数据库的负责，提高访问速度。</p><p>NHibernate.Caches.SysCache：我们通常DotNet上所使用的System.Web.Caching.Cache。</p><p>NHibernate.Caches.SysCache2：同上。不同的是增加了对于SQL2005的缓存依赖的支持。</p><p>NHibernate.Caches.Velocity：基于微软推出的分布式缓存Velocity组件。跟memcached一样，&#8220;Velocity&#8221;维护一张大的哈希表，这张表可以跨越多个服务器，你可以通过添加或者减少服务器来平衡系统压力。</p><p>二、什么是MongoDB？</p><p> MongoDB是一个基于分布式文档存储的数据库。旨在为WEB应用提供可护展的高性能数据存储解决方案。它是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。他支持的数据结构非常松散，是类似json的bjson格式，因此可以存储比较复杂的数据类型。Mongo最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。 它的特点是高性能、易部署、易使用，存储数据非常方便。</p><p>MongoDB官方服务端下载地址：http://www.mongodb.org/downloads</p><p>MongoDB官方客户端（.NET）下载地址：https://github.com/samus/mongodb-csharp</p><p>三、准备工作</p><p>服务器端下载下来后，首先要安装MongoDB，大家可以参考下这篇文章：http://www.cnblogs.com/mamboer/archive/2010/03/05/1679292.html</p><p>在你开发之前必须先吧MongoDB的服务或者控制台启动。这里我采用启动控制台。</p><p> </p><p>从图中看出，MongoDB采用的默认端口是27017，并且在我安装的时候，将MongoDB的数据库目录配置在：C:\data\db上。</p><p> 现在开始，我要增加一个支持MongoDB的缓存组件，那么首先要先了解它们二级缓存流程的一些机制，本篇先不具体谈它的原理（会在下篇具体描述），先谈下它是如何实现的，要研究如何实现其实很简单，依葫芦画瓢，去看人家写的代码。</p><p>四、分析与实现</p><p>1. 在Spring.NET关于NHibernate的配置中，可以启用二级缓存其中有个配置节点是：</p><!--Code highlighting produced by Actipro CodeHighlighter (freeware)http://www.CodeHighlighter.com/-->&lt;entrykey="cache.provider_class"value="NHibernate.Cache.HashtableCacheProvider"/&gt;

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>