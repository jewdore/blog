---
layout: post
title: 浅析MongoDB及C#驱动程序生成ObjectId
---

<p>   如果是在分布式高并发量的应用下，应该使用客户端的驱动程序来生成ObjectId。如果选择自动生成，增加数据库的负荷。</p>如何使用C#驱动程序生成ObjectId<p>     一、C#驱动程序选择:mongodb-csharp 项目地址：http://github.com/samus/mongodb-csharp</p><p>     二、ObjectId的结构：http://helloyesyes.iteye.com/blog/1089927</p><p>     三、了解了ObjectId的结构之后下面是如何实现</p><p>       1、<strong style="font-weight: bold;">TimeStamp（时间戳）：</p><p>           private int GenerateTime()</p><p>           {</p><p>              var now = DateTime.UtcNow;                </p><p>              var diff = now - BsonInfo.Epoch;</p><p>             return Convert.ToInt32(Math.Floor(diff.TotalSeconds));</p><p>           }</p><p>       2、<strong style="font-weight: bold;">Machine（主机唯一标识符）：</p><p>        private byte[] GenerateHostHash()</p><p>        {</p><p>           var md5 = MD5.Create();</p><p>           var host = Dns.GetHostName();</p><p>           return md5.ComputeHash(Encoding.Default.GetBytes(host));</p><p>        }</p><p>       3、P<strong style="font-weight: bold;">id（进程标识符）：</p><p>      private int GenerateProcId()</p><p>      {</p><p>        var proc = Process.GetCurrentProcess();</p><p>        return proc.Id;</p><p>      }</p><p>      4、I<strong style="font-weight: bold;">ncrement（自增计数器）：</p><p>      private readonly object _inclock = new object();</p><p>       private int GenerateInc()</p><p>      {</p><p>          lock(_inclock)</p><p>          {</p><p>             return ++_inc;</p><p>          }</p><p>        }</p><p>     5、生成ObjectId</p><p>      //生成ObjectId</p><p>    public Oid Generate()</p><p>    {</p><p>      var oid = new byte[12];</p><p>      var copyidx = 0;</p><p>      var time = BitConverter.GetBytes(GenerateTime());</p><p>      Array.Reverse(time);</p><p>      Array.Copy(time, 0, oid, copyidx, 4);</p><p>      copyidx += 4;</p><p>      Array.Copy(GenerateHostHash(), 0, oid, copyidx, 3);</p><p>      copyidx += 3;</p><p>      Array.Copy(GenerateProcId(), 2, oid, copyidx, 2);</p><p>      copyidx += 2;</p><p>      var inc = BitConverter.GetBytes(GenerateInc());</p><p>      Array.Reverse(inc);</p><p>      Array.Copy(inc, 1, oid, copyidx, 3);</p><p>      return new Oid(oid);</p><p>    }</p>欢迎拍砖,你的顶就是我的动力------------不过拍轻点。

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>