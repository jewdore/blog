---
layout: post
title: 使用Django开发一个图书管理系统  05---改造界面
---

<p>BOOKMS是一个公司内部的图书管理系统。 <p>本系列用多次迭代方法，逐步实现一个图书管理系统BOOKMS。 <p>本文主要介绍使用bootstrap美化前台页面和修改admin模块的添加图书模块时使用豆瓣api获取数据。 <p>再前一节里我们一件可以管理model（增删改查）。但是界面是在是太简陋，简陋到但凡是个正常人估计都无法接受。项目组里没有专业的前端的话，页面美化是一个痛苦的事，但是有了bootstrap的帮助之后，我们的页面也能像模像样。 一。Bootstrap介绍 <p>Bootstrap是Twitter推出的一个开源的用于前端开发的工具包。它由Twitter的设计师Mark Otto和Jacob Thornton合作开发，是一个CSS/HTML框架。Bootstrap提供了优雅的HTML和CSS规范，它即是由动态CSS语言Less写成，与CSS框架Blueprint存在很多相似之处。Bootstrap一经推出后颇受欢迎，一直是GitHub上的热门开源项目，包括NASA的code.nasa.gov和MSNBC（微软全国广播公司）的Breaking News都使用了该项目。  <p>可以直接到http://twitter.github.com/bootstrap/下载使用。Bootstrap的出现造就了一大批黑硬工具条+小清新内容栏目组合的风格页面。 二。项目改造，引入静态资源 <p>我们在项目里增加如下目录： <p> <p>很显然，其中的css放置样式表、html放置设计好的静态页面、js放置脚本。我们把下载到的Bootstrap里的文件分别放入。 <p>要让静态资源起作用，我们需要修改setting.py文件（还记得这文件吧，反复改啊反复改）：<pre class="brush: py; auto-links: true; collapse: false; first-line: 1; gutter: true; html-script: false; light: false; ruler: false; smart-tabs: true; tab-size: 4; toolbar: true;">import osSTATICFILES_DIRS = (os.path.dirname(__file__)+STATIC_URL,)</pre><p>然后再在bookms的urls.py里增加一条静态文件的路由：<pre class="brush: py; auto-links: true; collapse: false; first-line: 1; gutter: true; html-script: false; light: false; ruler: false; smart-tabs: true; tab-size: 4; toolbar: true;">from django.contrib.staticfiles.urls import staticfiles_urlpatternsurlpatterns += staticfiles_urlpatterns()</pre><p>动server，就可以通过http://127.0.0.1:8000/static/xxx 直接浏览静态文件了。三。改造项目里的模板<p>首先来改造base.html。base就是全站的基础母版（相当于asp.net的母版页）。<pre class="brush: py; auto-links: true; collapse: false; first-line: 1; gutter: true; html-script: false; light: false; ruler: false; smart-tabs: true; tab-size: 4; toolbar: true;">&lt;!DOCTYPE html&gt;&lt;html lang="en"&gt;&lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;title&gt;{% block title %} {% endblock %}&lt;/title&gt;&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;&lt;meta name="description" content=""&gt;&lt;meta name="author" content=""&gt;&lt;!-- Le styles --&gt;&lt;link href="/static/css/bootstrap.css" rel="stylesheet"&gt;&lt;style type="text/css"&gt;body {padding-top: 60px;padding-bottom: 40px;}.sidebar-nav {padding: 9px 0;}&lt;/style&gt;&lt;link href="../assets/css/bootstrap-responsive.css" rel="stylesheet"&gt;&lt;!-- Le HTML5 shim, for IE6-8 support of HTML5 elements --&gt;&lt;!--[if lt IE 9]&gt;&lt;script src="&lt;/SCRIPT'"&gt;http://html5shim.googlecode.com/svn/trunk/html5.js"&gt;&lt;/script&gt;&lt;![endif]--&gt;&lt;/head&gt;&lt;body&gt;&lt;div class="navbar navbar-fixed-top"&gt;&lt;div class="navbar-inner"&gt;&lt;div class="container-fluid"&gt;&lt;a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"&gt;&lt;span class="icon-bar"&gt;&lt;/span&gt;&lt;span class="icon-bar"&gt;&lt;/span&gt;&lt;span class="icon-bar"&gt;&lt;/span&gt;&lt;/a&gt;&lt;a class="brand" href="#"&gt;图书管理&lt;/a&gt;&lt;div class="btn-group pull-right"&gt;&lt;a class="btn dropdown-toggle" data-toggle="dropdown" href="#"&gt;&lt;i class="icon-user"&gt;&lt;/i&gt; Username&lt;span class="caret"&gt;&lt;/span&gt;&lt;/a&gt;&lt;ul class="dropdown-menu"&gt;&lt;li&gt;&lt;a href="#"&gt;个人资料&lt;/a&gt;&lt;/li&gt;&lt;li class="divider"&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="#"&gt;退出系统&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;div class="nav-collapse"&gt;&lt;ul class="nav"&gt;&lt;li class="active"&gt;&lt;a href="#"&gt;首页&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="#about"&gt;图书管理&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="#about"&gt;关于&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;!--/.nav-collapse --&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="container-fluid"&gt;&lt;div class="row-fluid"&gt;&lt;div class="span2"&gt;&lt;div class="well sidebar-nav"&gt;&lt;ul class="nav nav-list"&gt;&lt;li class="nav-header"&gt;图书管理&lt;/li&gt;&lt;li class="active"&gt;&lt;a href="#"&gt;图书列表&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="#"&gt;我的图书&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="#"&gt;请求处理&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;!--/.well --&gt;&lt;/div&gt;&lt;!--/span--&gt;&lt;div class="span10"&gt;{% block content %}{% endblock %}&lt;/div&gt;&lt;!--/span--&gt;&lt;/div&gt;&lt;!--/row--&gt;&lt;hr&gt;&lt;footer&gt;&lt;p&gt;&amp;copy; Company 2012&lt;/p&gt;&lt;/footer&gt;&lt;/div&gt;&lt;!--/.fluid-container--&gt;&lt;!-- Le javascript================================================== --&gt;&lt;!-- Placed at the end of the document so the pages load faster --&gt;&lt;script src="/static/js/jquery.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-transition.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-alert.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-modal.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-dropdown.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-scrollspy.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-tab.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-tooltip.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-popover.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-button.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-collapse.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-carousel.js"&gt;&lt;/script&gt;&lt;script src="/static/js/bootstrap-typeahead.js"&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;</pre><p> <p> <p>然后是我们的list_book.html:<pre class="brush: py; auto-links: true; collapse: false; first-line: 1; gutter: true; html-script: false; light: false; ruler: false; smart-tabs: true; tab-size: 4; toolbar: true;">{% extends "base.html" %}{% block title %} 图书列表 {% endblock %}{% block content %}&lt;div class="row-fluid"&gt;&lt;a class="btn btn-success" href="{% url bookapp.views.create_book %}"&gt; &lt;span class=" icon-plus icon-white" &gt;&lt;/span&gt;增加图书 &lt;/a&gt;&lt;/div&gt;{% for item in list_items.object_list %}&lt;div class="row-fluid"&gt;&lt;div class="span1"&gt;&lt;img src="{{item.cover_img}}"/&gt;&lt;/div&gt;&lt;div class="span11"&gt;&lt;h2&gt;{{item.title}}&lt;/h2&gt;&lt;p&gt;{{item.summary}}&lt;/p&gt;&lt;p&gt;&lt;a class="btn btn-info" href="{% url bookapp.views.view_book item.id %}"&gt;&lt;span class=" icon-check icon-white" &gt;&lt;/span&gt;详细 &lt;/a&gt;&lt;a class="btn btn-danger" href="{% url bookapp.views.edit_book item.id %}"&gt; &lt;span class=" icon-check icon-white" &gt;&lt;/span&gt;修改 &lt;/a&gt;&lt;a class="btn btn-danger" href="#"&gt; &lt;span class=" icon-check icon-white" &gt;&lt;/span&gt;归还 &lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;&lt;hr&gt;{% endfor %}&lt;div class="row-fluid"&gt;{% if list_items.has_previous %}&lt;a href="?page={{ list_items.previous_page_number }}"&gt;上一页&lt;/a&gt;{% endif %}&lt;span class="current"&gt;Page {{ list_items.number }} of {{ list_items.paginator.num_pages }}.&lt;/span&gt;{% if list_items.has_next %}&lt;a href="?page={{ list_items.next_page_number }}"&gt;下一页&lt;/a&gt;{% endif %}&lt;/div&gt;{% endblock %}</pre><p> <p>这时候我们可以运行后去看看效果了<p>http://127.0.0.1:8000/bookapp/book/list<p>四。改造后台admin模块，调用豆瓣api<p>现在我们的管理员已经可以在后台录入图书信息了，但是字段相当的多，录入的工作量相当巨大。这里我们再偷懒一下，通过isbn到豆瓣api获取数据，尝试一下。<p>文艺青年都上豆瓣，但是更文艺的青年呢，直接用豆瓣api 。<p>豆瓣的API需要申请一个KEY，豆瓣也允许在不申请API Key的情况下进行API调用。不过在这种情况下，API调用被限制为每分钟请求不超过10次。使用API Key时，对访问的限制较为宽松，为每分钟40次，超过限制的话会被封禁。我们测试的就先不用apikey了。<p>先看下豆瓣的api客户端：<p>http://www.douban.com/service/apidoc/clients<p>我们看其中的js客户端。<pre>&lt;script type="text/javascript" src="http://www.douban.com/js/api.js?v=2" /&gt;</pre><pre>&lt;script type="text/javascript" src="http://www.douban.com/js/api-parser.js?v=1"&gt;&lt;/script&gt;</pre><p>这2个我们都需要用到，这里我直接下载了它们放到前面引入的静态文件夹目录 /bookms/static/js里。<p>关于admin模块的改造，推荐一篇文章：<p>http://www.ibm.com/developerworks/cn/opensource/os-django-admin/?ca=drs-tp4608<p>这里我们只需要改造添加图书这个功能的模板页面即可（输入isbn后通过js调用豆瓣api，解析返回值填入各输入框），所以我们做的改造实际上是扩展了添加图书这个模板而已。在/bookms/templates/bookapp/book下新建一个html文件change_form.html<p>文件内容如下：<pre class="brush: py; auto-links: true; collapse: false; first-line: 1; gutter: true; html-script: false; light: false; ruler: false; smart-tabs: true; tab-size: 4; toolbar: true;">{% extends "admin/change_form.html" %}{% block extrahead %}&lt;script src="/static/js/jquery.js"&gt;&lt;/script&gt;&lt;script src="/static/js/douban/api.js"&gt;&lt;/script&gt;&lt;script src="/static/js/douban/api-parser.js"&gt;&lt;/script&gt;&lt;script language="javascript"&gt;$(document).ready(function(){$("#id_isbn").after("&lt;span&gt;输入10位或13位ISBN后回车，系统将自动获取图书信息&lt;/span&gt;");$(":input").keypress(function(e) {var key = e.which;if (13 == key) {e.preventDefault();if(this.id=="id_isbn"){fnFromDouban();}var index = $(":input").index(this);var newIndex = index + 1;$(":input:eq(" + newIndex + ")").focus();}});});function fnFromDouban(){var reg=/^\d{10}|d{13}$/;if(!reg.test($("#id_isbn").val())){return false;}var bookid;DOUBAN.apikey = '你的豆瓣api key';DOUBAN.searchBooks({keyword:$("#id_isbn").get(0).value,callback:function(bookinfo){var list = DOUBAN.parseSubjects(bookinfo).entries;if(list==null||list.length==0){alert("没有这本书，检查看看isbn是否出错了呢。");$("#id_isbn").focus();}else{bookid=list[0].nid;DOUBAN.getBook({id:bookid,callback:function(re){var book = DOUBAN.parseSubject(re);$("#id_title").val(book.title ? book.title : "");$("#id_summary").val(book.summary ? book.summary : "--");$("#id_subtitle").val(book.attribute["subtitle"]? book.attribute["subtitle"] : "--" );$("#id_author").val(book.attribute["author"]);$("#id_translator").val(book.attribute["translator"]);$("#id_pages").val(book.attribute["pages"]);$("#id_price").val(book.attribute["price"]);$("#id_publisher").val(book.attribute["publisher"]);$("#id_pubdate").val(book.attribute["pubdate"]);$("#id_cover_img").val(book.link.image);$("#id_author_intro").val(book.attribute["author-intro"]);}})}}})return false;}&lt;/script&gt;{% endblock %}</pre><p> <p>这里我们只不过扩展了一下模板。加入了一下js。js里首先捕获了input里的回车按键，因为我这更偷懒的用了扫码枪，扫码枪默认的是扫到结果后帮你按个回车。<p>在回头改造一下/bookms/bookapp/admin.py里的BookAdmin类，让admin模块里book类的显示更符合我们要求。<pre class="brush: py; auto-links: true; collapse: false; first-line: 1; gutter: true; html-script: false; light: false; ruler: false; smart-tabs: true; tab-size: 4; toolbar: true;">class BookAdmin(admin.ModelAdmin):list_display = (id','isbn', 'title', 'author','translator','publisher','type',)list_filter = ('type','publisher',)search_fields = (id','title','isbn',)list_per_page=20</pre><p>来看看效果吧：<p><p>截图会有些出入，因为我是从运行的系统里截的~~~

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>