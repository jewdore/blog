---
layout: post
title: using OpenCV with iOS SDK
---

<p>OpenCV is a library of computer vision developed by Intel, we can easily detect faces using this library for example. I&rsquo;d note how to use it with iOS SDK, including the building scripts and a demo application. Here I attached screen shots from the demo applications.</p>Support Latest OpenCV and iOS SDK<p>Updated the project, support OpenCV 2.2.0, iOS SDK 4.3, Xcode 4 (Updated 04/17/2011.)</p>Getting Started<p>All source codes and resources are opened and you can get them frommy github repository. It includes pre-compiled OpenCV libraries and headers so that you can easily start to test it. If you already have git command, just clone whole repository from github. If not, just take it by zip or tar from download link on github and inflate it.</p><pre><code class="terminal">% git clone git://github.com/niw/iphone_opencv_test.git </code></pre><p>After getting source codes, open OpenCVTest.xcodeproj with Xcode, then build it. You will get a demo application on both iPhone Simulator and iPhone device.</p>Building OpenCV library from source code<ul class="images"><p>You can also make OpenCV library from source code using cross environment compile with gcc. I added some support script so that you can easy to do so. The important point is that iOS SDK doesn&rsquo;t support dynamic link like &ldquo;.framework&rdquo;. We have to make it as static link library and link it to your application statically.</p><ol><p>Building OpenCV requiersCMake. You can easily install it by usingHomebreworMacPorts.</p><pre><code class="terminal"># Using Homebrew % brew install cmake # Using MacPorts % sudo port install cmake -gui </code></pre><p>If you&rsquo;ve already installed recent Java update, you may be asked to install<code>javadeveloper_10.6_10m3261.dmg</code>. This is weird but cmake needs jni.h which is removed from recent Java update, you can download it fromhere for Mac OS X 10.6which may require you to subscribe Apple Developer Connection. Yes, Apple is nowgoing to deprecate Java on MacOS X(Updated 10/30/2010).</p><p>Getting source code from sourceforge. I tested withOpenCV-2.2.0.tar.bz2.</p><p>Extract downloaded archive on the top of demo project directory</p><pre><code class="terminal">% tar xjvf OpenCV-2.2.0.tar.bz2 </code></pre><p>Apply patch for iOS SDK</p><pre><code class="terminal">% cd OpenCV-2.2.0 % patch -p1 &lt; ../OpenCV-2.2.0.patch </code></pre><p>Following next steps to build OpenCV static library for simulator. All files are installed into<code>opencv_simulator</code>directory. When running<code>make</code>command, you&rsquo;ve better assign<code>-j</code>option and number according to number of your CPU cores. Without<code>-j</code>option, it takes a long time.</p><pre><code class="terminal">% cd .. # Back to the top of demo project directory. % mkdir build_simulator % cd build_simulator % ../opencv_cmake.sh Simulator ../OpenCV-2.2.0 % make -j 4 % make install </code></pre><p>Following next steps to build OpenCV static library for device All files are installed into<code>opencv_device</code>directory.</p><pre><code class="terminal">% cd .. # Back to the top of demo project directory. % mkdir build_device % cd build_device % ../opencv_cmake.sh Device ../OpenCV-2.2.0 % make -j 4 % make install </code></pre></ol>Build support script<p>Build support script<code>opencv_cmake.sh</code>has some options to build OpenCV with iOS SDK. Try<code>--help</code>option to get the all options of it.</p>Converting images between UIImage and IplImage<p>OpenCV is using IplImage structure for processing, and iOS SDK using UIImage object to display it on the screen. This means, we need a converter between UIImage and IplImage. Thankfully, we can do with iOS SDK APIs.</p><p>Creating IplImage from UIImage is like this.</p><pre><code class="objc">// NOTE you SHOULD cvReleaseImage() for the return value when end of the code. - (IplImage *)CreateIplImageFromUIImage:(UIImage *)image { // Getting CGImage from UIImage CGImageRef imageRef = image.CGImage; CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB(); // Creating temporal IplImage for drawing IplImage *iplimage = cvCreateImage( cvSize(image.size.width,image.size.height), IPL_DEPTH_8U, 4 ); // Creating CGContext for temporal IplImage CGContextRef contextRef = CGBitmapContextCreate( iplimage-&gt;imageData, iplimage-&gt;width, iplimage-&gt;height, iplimage-&gt;depth, iplimage-&gt;widthStep, colorSpace, kCGImageAlphaPremultipliedLast|kCGBitmapByteOrderDefault ); // Drawing CGImage to CGContext CGContextDrawImage( contextRef, CGRectMake(0, 0, image.size.width, image.size.height), imageRef ); CGContextRelease(contextRef); CGColorSpaceRelease(colorSpace); // Creating result IplImage IplImage *ret = cvCreateImage(cvGetSize(iplimage), IPL_DEPTH_8U, 3); cvCvtColor(iplimage, ret, CV_RGBA2BGR); cvReleaseImage(&amp;iplimage); return ret; } </code></pre><p>Don&rsquo;t forget release IplImage after using it by cvReleaseImage!</p><p>And creating UIImage from IplImage is like this.</p><pre><code class="objc">// NOTE You should convert color mode as RGB before passing to this function - (UIImage *)UIImageFromIplImage:(IplImage *)image { CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB(); // Allocating the buffer for CGImage NSData *data = [NSData dataWithBytes:image-&gt;imageData length:image-&gt;imageSize]; CGDataProviderRef provider = CGDataProviderCreateWithCFData((CFDataRef)data); // Creating CGImage from chunk of IplImage CGImageRef imageRef = CGImageCreate( image-&gt;width, image-&gt;height, image-&gt;depth, image-&gt;depth * image-&gt;nChannels, image-&gt;widthStep, colorSpace, kCGImageAlphaNone|kCGBitmapByteOrderDefault, provider, NULL, false, kCGRenderingIntentDefault ); // Getting UIImage from CGImage UIImage *ret = [UIImage imageWithCGImage:imageRef]; CGImageRelease(imageRef); CGDataProviderRelease(provider); CGColorSpaceRelease(colorSpace); return ret; } </code></pre><p>Ok, now you can enjoy with OpenCV with iPhone!</p>Using OpenCV library in your own project<p>The demo application which you can download from my repository is well configured to use these libraries. If you wanted to use OpenCV libraries on your own project, you should need to adding next configurations on it. You can see these settings on the Xcode project of this demo application.</p>Add<code>libopencv_core.a</code>etc, from OpenCV lib directory for either simulators or devices. Actually Xcode doesn&rsquo;t care which one is for devices or simulators at this point because it is selected by the library search path.Add<code>Accelerate.framework</code>which is used internally from OpenCV library.Select your active build target, then open the build tab in the info panel by Get Info menu.Add<code>-lstdc++</code>and<code>-lz</code>to Other Linker FlagsAdd path to OpenCV<code>include</code>directory to Header Search Paths for both simulators and devices.Add path to OpenCV<code>lib</code>directory to Library Search Paths for both simulators and devices.Change Log04/17/2011 - Support OpenCV 2.2.0 + iOS SDK 4.3 + Xcode 4, Thank you for all your comments!10/30/2010 - Updates for recent changes on the repository and the development environment, Thank you for your comments!08/22/2010 - Support OpenCV 2.1.0 + iOS SDK 4.012/21/2009 - Support Snow Leopard + iPhone SDK 3.1.2, Thank you Hyon!11/15/2009 - Support OpenCV 2.0.0 + iPhone SDK 3.x03/14/2009 - Release this project with OpenCV 1.0.0 + iPhone SDK 2.xDonation<p>If you would like to help this project, please feel free to donate viaPayPalusing the followin form. Thank you for your donation!</p>

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>