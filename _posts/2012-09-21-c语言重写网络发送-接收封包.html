---
layout: post
title: C语言重写网络发送/接收封包
---

<p>本文贴出用C语言重写的网络封包，主体设计思路前文已经介绍过，就是尽可能的共享缓存，减少不必要的内存拷贝.</p><p>其次，封包主要是为了适合网络游戏等有固定模式的，面向字节流的协议，所以并不适合用于http类协议的处理.</p><p>最后，代码没有做优化，内存的分配都是经由calloc,后面会用内存池代替。</p><p>项目地址:https://github.com/sniperHW/KendyNet/tree/master/IOCP</p><p>rpacket从网络中接收到的数据封包:</p><pre>#ifndef _RPACKET_H#define _RPACKET_H#include "buffer.h"typedef struct rpacket{    unsigned long cmd;    unsigned long len;     //包长    unsigned long rpos;    //读下标    unsigned long data_remain;    unsigned long binbufpos;    unsigned long begin_pos;    buffer_t binbuf;       //用于存放跨越buffer_t边界数据的buffer_t    buffer_t buf;          //存放此数据包内容的buffer_t链表    buffer_t readbuf;      //当前rpos所在的buffer_t}*rpacket_t;struct wpacket;rpacket_t rpacket_create(buffer_t,unsigned long pos);rpacket_t rpacket_create_by_wpacket(struct wpacket*);//通过wpacket构造void      rpacket_destroy(rpacket_t*);//数据读取接口unsigned long  rpacket_len(rpacket_t);unsigned long  rpacket_read_cmd(rpacket_t);unsigned long  rpacket_data_remain(rpacket_t);unsigned char  rpacket_read_char(rpacket_t);unsigned short rpacket_read_short(rpacket_t);unsigned long  rpacket_read_long(rpacket_t);double         rpacket_read_double(rpacket_t);const char*    rpacket_read_string(rpacket_t);const void*    rpacket_read_binary(rpacket_t,unsigned long *len);#endif</pre>

了解破碎机常识：<a href='http://www.crushermillsupplier.com'>crusher mill supplier</a>